(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const i of c)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function o(c){const i={};return c.integrity&&(i.integrity=c.integrity),c.referrerPolicy&&(i.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?i.credentials="include":c.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(c){if(c.ep)return;c.ep=!0;const i=o(c);fetch(c.href,i)}})();const p={wsUrl:"wss://lanser.fun/block/ws/gateway",reconnectInterval:5e3},t={ws:null,connected:!1,vehicleId:null,vehicles:[],executionId:null,workspace:null,codeGenerator:null},h={contents:[{kind:"category",name:"è¿åŠ¨",colour:"#4C97FF",contents:[{kind:"block",type:"motion_forward"},{kind:"block",type:"motion_backward"},{kind:"block",type:"motion_left"},{kind:"block",type:"motion_right"},{kind:"block",type:"motion_stop"}]},{kind:"category",name:"ä¼ æ„Ÿ",colour:"#99CA49",contents:[{kind:"block",type:"sensor_ultrasonic"}]},{kind:"category",name:"é€»è¾‘",colour:"#FFAB19",contents:[{kind:"block",type:"controls_if"},{kind:"block",type:"controls_repeat_ext"},{kind:"block",type:"delay_wait"}]}]};function y(){t.codeGenerator=new Blockly.Generator("Python"),t.codeGenerator.ORDER_ATOMIC=0,t.codeGenerator.ORDER_NONE=0,t.codeGenerator.INDENT="    ";const e=Blockly.inject("blockly-div",{toolbox:h,scrollbars:!0,trashcan:!0,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.3,scaleSpeed:1.2},grid:{spacing:20,length:3,colour:"#ccc",snap:!0}});t.workspace=e,e.addChangeListener(k),console.log("Blocklyåˆå§‹åŒ–å®Œæˆ")}function k(){if(!(!t.workspace||!t.codeGenerator))try{const e=t.codeGenerator.workspaceToCode(t.workspace);document.getElementById("code-preview").textContent=e||"# ç”Ÿæˆçš„ä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"}catch(e){console.error("ä»£ç ç”Ÿæˆå¤±è´¥:",e)}}function g(){Blockly.Blocks.motion_forward={init:function(){this.appendDummyInput().appendField("â¬†ï¸ å‰è¿›").appendField(new Blockly.FieldDropdown([["ğŸ¢ æ…¢é€Ÿ","30"],["ğŸš¶ ä¸­é€Ÿ","50"],["ğŸƒ å¿«é€Ÿ","70"]]),"SPEED"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(230)}},Blockly.Blocks.motion_backward={init:function(){this.appendDummyInput().appendField("â¬‡ï¸ åé€€").appendField(new Blockly.FieldDropdown([["ğŸ¢ æ…¢é€Ÿ","30"],["ğŸš¶ ä¸­é€Ÿ","50"],["ğŸƒ å¿«é€Ÿ","70"]]),"SPEED"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(230)}},Blockly.Blocks.motion_left={init:function(){this.appendDummyInput().appendField("â¬…ï¸ å·¦å¹³ç§»").appendField(new Blockly.FieldDropdown([["ğŸ¢ æ…¢é€Ÿ","30"],["ğŸš¶ ä¸­é€Ÿ","50"],["ğŸƒ å¿«é€Ÿ","70"]]),"SPEED"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(230)}},Blockly.Blocks.motion_right={init:function(){this.appendDummyInput().appendField("â¡ï¸ å³å¹³ç§»").appendField(new Blockly.FieldDropdown([["ğŸ¢ æ…¢é€Ÿ","30"],["ğŸš¶ ä¸­é€Ÿ","50"],["ğŸƒ å¿«é€Ÿ","70"]]),"SPEED"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(230)}},Blockly.Blocks.motion_stop={init:function(){this.appendDummyInput().appendField("ğŸ›‘ åœæ­¢"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(230)}},Blockly.Blocks.sensor_ultrasonic={init:function(){this.appendDummyInput().appendField("ğŸ“¡ è¶…å£°æ³¢è·ç¦»"),this.setOutput(!0,"Number"),this.setColour(120)}},Blockly.Blocks.controls_if={init:function(){this.appendValueInput("CONDITION").setCheck("Boolean").appendField("å¦‚æœ"),this.appendStatementInput("DO").appendField("å°±"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(330)}},Blockly.Blocks.controls_repeat_ext={init:function(){this.appendValueInput("TIMES").setCheck("Number").appendField("é‡å¤æ‰§è¡Œ"),this.appendStatementInput("DO").appendField("æ¬¡"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(330)}},Blockly.Blocks.delay_wait={init:function(){this.appendValueInput("SECONDS").setCheck("Number").appendField("ç­‰å¾…"),this.appendDummyInput().appendField("ç§’"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(330)}},console.log("ç§¯æœ¨å—å®šä¹‰å®Œæˆ")}function E(){t.codeGenerator.forBlock.motion_forward=function(e){return`motion.qianjin(${e.getFieldValue("SPEED")})
`},t.codeGenerator.forBlock.motion_backward=function(e){return`motion.houtui(${e.getFieldValue("SPEED")})
`},t.codeGenerator.forBlock.motion_left=function(e){return`motion.zuopingyi(${e.getFieldValue("SPEED")})
`},t.codeGenerator.forBlock.motion_right=function(e){return`motion.youpingyi(${e.getFieldValue("SPEED")})
`},t.codeGenerator.forBlock.motion_stop=function(e){return`motion.tingzhi()
`},t.codeGenerator.forBlock.sensor_ultrasonic=function(e){return["sensor.heshengbo()",t.codeGenerator.ORDER_MEMBER]},t.codeGenerator.forBlock.controls_if=function(e){const n=t.codeGenerator.valueToCode(e,"CONDITION",t.codeGenerator.ORDER_NONE)||"False",o=t.codeGenerator.statementToCode(e,"DO");return o=t.codeGenerator.addLoopTrap(o,e),`if ${n}:
${o}
`},t.codeGenerator.forBlock.controls_repeat_ext=function(e){const n=t.codeGenerator.valueToCode(e,"TIMES",t.codeGenerator.ORDER_NONE)||"0",o=t.codeGenerator.statementToCode(e,"DO");return o=t.codeGenerator.addLoopTrap(o,e),`for _ in range(${n}):
${o}
`},t.codeGenerator.forBlock.delay_wait=function(e){return`dengdai(${t.codeGenerator.valueToCode(e,"SECONDS",t.codeGenerator.ORDER_NONE)||"0"})
`},console.log("ä»£ç ç”Ÿæˆå™¨å®šä¹‰å®Œæˆ")}function f(){t.ws&&t.ws.close(),t.ws=new WebSocket(p.wsUrl),t.ws.onopen=()=>{console.log("WebSocketå·²è¿æ¥"),t.connected=!0,m(!0),l({type:"client_register",data:{client_id:C()}}),l({type:"get_vehicle_list",data:{}})},t.ws.onmessage=e=>{const n=JSON.parse(e.data);b(n)},t.ws.onerror=e=>{console.error("WebSocketé”™è¯¯:",e)},t.ws.onclose=()=>{console.log("WebSocketå·²æ–­å¼€"),t.connected=!1,m(!1),setTimeout(f,p.reconnectInterval)}}function l(e){t.ws&&t.ws.readyState===WebSocket.OPEN?(e.vehicle_id=t.vehicleId,e.timestamp=Date.now(),t.ws.send(JSON.stringify(e))):console.warn("WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯")}function b(e){const{type:n,data:o,vehicle_id:r}=e;switch(n){case"vehicle_list":I(o.vehicles);break;case"vehicle_status":B(r,o);break;case"execution_started":S(o);break;case"execution_finished":w();break;case"execution_error":x(o);break;case"sensor_update":_(o.sensors);break;case"error":u(o.message);break;default:console.log("æœªçŸ¥æ¶ˆæ¯ç±»å‹:",n)}}function m(e){const n=document.getElementById("connection-status"),o=n.querySelector(".status-text");e?(n.className="status-indicator online",o.textContent="å·²è¿æ¥",s(!0)):(n.className="status-indicator offline",o.textContent="æœªè¿æ¥",s(!1))}function I(e){t.vehicles=e;const n=document.getElementById("vehicle-select");n.innerHTML='<option value="">é€‰æ‹©å°è½¦...</option>',e.forEach(o=>{const r=document.createElement("option");r.value=o.vehicle_id,r.textContent=`${o.name} (${o.online?"åœ¨çº¿":"ç¦»çº¿"})`,r.disabled=!o.online,n.appendChild(r)})}function B(e,n){e===t.vehicleId&&s(n.online&&!n.busy)}function _(e){e.ultrasonic!==void 0&&(document.getElementById("sensor-ultrasonic").textContent=e.ultrasonic),e.infrared&&(document.getElementById("sensor-line").textContent=e.infrared.map(n=>n?"â—":"â—‹").join(" ")),e.battery!==void 0&&(document.getElementById("sensor-battery").textContent=e.battery.toFixed(1))}function s(e){document.getElementById("btn-run").disabled=!e||!t.vehicleId,document.getElementById("btn-stop").disabled=!e,document.getElementById("btn-emergency").disabled=!e}function S(e){t.executionId=e.execution_id,d("ä»£ç æ­£åœ¨æ‰§è¡Œ..."),document.getElementById("btn-run").disabled=!0,document.getElementById("btn-stop").disabled=!1}function w(e){t.executionId=null,d("ä»£ç æ‰§è¡Œå®Œæˆ"),document.getElementById("btn-run").disabled=!1,document.getElementById("btn-stop").disabled=!0}function x(e){t.executionId=null,u("æ‰§è¡Œé”™è¯¯: "+e.error),document.getElementById("btn-run").disabled=!1,document.getElementById("btn-stop").disabled=!0}function d(e){document.getElementById("status-message").textContent=e}function u(e){d("âŒ "+e),console.error(e)}function C(){return"client_"+Math.random().toString(36).substr(2,9)}function v(){return"exec_"+Date.now()+"_"+Math.random().toString(36).substr(2,5)}function D(){document.getElementById("vehicle-select").addEventListener("change",e=>{t.vehicleId=e.target.value,s(t.connected&&t.vehicleId),d(t.vehicleId?`å·²é€‰æ‹©: ${t.vehicleId}`:"è¯·é€‰æ‹©å°è½¦")}),document.getElementById("btn-run").addEventListener("click",()=>{const e=t.codeGenerator.workspaceToCode(t.workspace);if(!e||e.trim()===""){u("è¯·å…ˆæ‹–æ‹½ç§¯æœ¨å—");return}const n=v();l({type:"execute_code",data:{code:e,timeout:60,execution_id:n}})}),document.getElementById("btn-stop").addEventListener("click",()=>{t.executionId&&l({type:"stop_execution",data:{execution_id:t.executionId}})}),document.getElementById("btn-emergency").addEventListener("click",()=>{l({type:"emergency_stop",data:{}})})}function N(){console.log("åˆå§‹åŒ–Blocklyå°è½¦ç¼–ç¨‹..."),g(),E(),y(),D(),f(),console.log("åˆå§‹åŒ–å®Œæˆ")}document.addEventListener("DOMContentLoaded",N);
